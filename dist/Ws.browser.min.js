!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):((e=e||self).adonis=e.adonis||{},e.adonis.Ws=t())}(this,function(){"use strict";function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}function t(e,t,n,r,o,i,s){try{var a=e[i](s),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,o)}function n(e){return function(){var n=this,r=arguments;return new Promise(function(o,i){var s=e.apply(n,r);function a(e){t(s,o,i,a,c,"next",e)}function c(e){t(s,o,i,a,c,"throw",e)}a(void 0)})}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function i(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function f(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function l(e,t){return e(t={exports:{}},t.exports),t.exports}var h=l(function(t,n){t.exports=function(){var t="function"==typeof Symbol&&"symbol"==e(Symbol.iterator)?function(t){return e(t)}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":e(t)},n={OPEN:0,JOIN:1,LEAVE:2,JOIN_ACK:3,JOIN_ERROR:4,LEAVE_ACK:5,LEAVE_ERROR:6,EVENT:7,PING:8,PONG:9};function r(e,t,n){return n.forEach(function(e){!function(e,t){if(!e||"string"!=typeof e)throw new Error(t)}(t[e],"expected "+e+" to be a valid string")}),{t:e,d:t}}var o={};return Object.keys(n).forEach(function(e){var r=e.toLowerCase().replace(/^\w|_(\w)/g,function(e,t){return t?t.toUpperCase():e.toUpperCase()});o["is"+r+"Packet"]=function(r){return!(!r||"object"!==(void 0===r?"undefined":t(r))||r.t!==n[e])}}),o.hasTopic=function(e){return!!(e&&e.d&&e.d.topic)},o.isValidJoinPacket=o.hasTopic,o.isValidLeavePacket=o.hasTopic,o.isValidEventPacket=o.hasTopic,o.joinPacket=function(e){return r(n.JOIN,{topic:e},["topic"])},o.leavePacket=function(e){return r(n.LEAVE,{topic:e},["topic"])},o.joinAckPacket=function(e){return r(n.JOIN_ACK,{topic:e},["topic"])},o.joinErrorPacket=function(e,t){return r(n.JOIN_ERROR,{topic:e,message:t},["topic","message"])},o.leaveAckPacket=function(e){return r(n.LEAVE_ACK,{topic:e},["topic"])},o.leaveErrorPacket=function(e,t){return r(n.LEAVE_ERROR,{topic:e,message:t},["topic","message"])},o.eventPacket=function(e,t,o){return r(n.EVENT,{topic:e,event:t,data:o=o||""},["topic","event"])},o.pingPacket=function(){return{t:n.PING}},o.pongPacket=function(){return{t:n.PONG}},Object.assign({codes:n},o)}()}),p=new WeakMap,v=new WeakMap,d=new WeakMap,y=Symbol("anyProducer"),m=Promise.resolve();function b(e){if("string"!=typeof e)throw new TypeError("eventName must be a string")}function g(e){if("function"!=typeof e)throw new TypeError("listener must be a function")}function k(e,t){var n=v.get(e);return n.has(t)||n.set(t,new Set),n.get(t)}function w(e,t){var n="string"==typeof t?t:y,r=d.get(e);return r.has(n)||r.set(n,new Set),r.get(n)}function _(e,t,n){var r=d.get(e);if(r.has(t)){var o=!0,i=!1,s=void 0;try{for(var a,c=r.get(t)[Symbol.iterator]();!(o=(a=c.next()).done);o=!0){a.value.enqueue(n)}}catch(e){i=!0,s=e}finally{try{o||null==c.return||c.return()}finally{if(i)throw s}}}if(r.has(y)){var u=Promise.all([t,n]),f=!0,l=!1,h=void 0;try{for(var p,v=r.get(y)[Symbol.iterator]();!(f=(p=v.next()).done);f=!0){p.value.enqueue(u)}}catch(e){l=!0,h=e}finally{try{f||null==v.return||v.return()}finally{if(l)throw h}}}}function E(e,t){var r,o,i,s=!1,a=function(){},c=[],u={enqueue:function(e){c.push(e),a()},finish:function(){s=!0,a()}};return w(e,t).add(u),r={next:function(){var e=this;return n(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(c){t.next=2;break}return t.abrupt("return",{done:!0});case 2:if(0!==c.length){t.next=9;break}if(!s){t.next=6;break}return c=void 0,t.abrupt("return",e.next());case 6:return t.next=8,new Promise(function(e){a=e});case 8:return t.abrupt("return",e.next());case 9:return t.next=11,c.shift();case 11:return t.t0=t.sent,t.abrupt("return",{done:!1,value:t.t0});case 13:case"end":return t.stop()}},t)}))()},return:function(r){var o=arguments;return n(regeneratorRuntime.mark(function n(){return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(c=void 0,w(e,t).delete(u),a(),!(o.length>0)){n.next=10;break}return n.next=6,r;case 6:n.t1=n.sent,n.t0={done:!0,value:n.t1},n.next=11;break;case 10:n.t0={done:!0};case 11:return n.abrupt("return",n.t0);case 12:case"end":return n.stop()}},n)}))()}},o=Symbol.asyncIterator,i=function(){return this},o in r?Object.defineProperty(r,o,{value:i,enumerable:!0,configurable:!0,writable:!0}):r[o]=i,r}function x(e){if(void 0===e)return P;if(!Array.isArray(e))throw new TypeError("`methodNames` must be an array of strings");var t=!0,n=!1,r=void 0;try{for(var o,i=e[Symbol.iterator]();!(t=(o=i.next()).done);t=!0){var s=o.value;if(!P.includes(s)){if("string"!=typeof s)throw new TypeError("`methodNames` element must be a string");throw new Error("".concat(s," is not Emittery method"))}}}catch(e){n=!0,r=e}finally{try{t||null==i.return||i.return()}finally{if(n)throw r}}return e}var S=function(){function t(){r(this,t),p.set(this,new Set),v.set(this,new Map),d.set(this,new Map)}return i(t,null,[{key:"mixin",value:function(e,n){return n=x(n),function(r){if("function"!=typeof r)throw new TypeError("`target` must be function");var o=!0,i=!1,s=void 0;try{for(var a,c=n[Symbol.iterator]();!(o=(a=c.next()).done);o=!0){var u=a.value;if(void 0!==r.prototype[u])throw new Error("The property `".concat(u,"` already exists on `target`"))}}catch(e){i=!0,s=e}finally{try{o||null==c.return||c.return()}finally{if(i)throw s}}Object.defineProperty(r.prototype,e,{enumerable:!1,get:function(){return Object.defineProperty(this,e,{enumerable:!1,value:new t}),this[e]}});var f=function(t){return function(){var n;return(n=this[e])[t].apply(n,arguments)}},l=!0,h=!1,p=void 0;try{for(var v,d=n[Symbol.iterator]();!(l=(v=d.next()).done);l=!0){var y=v.value;Object.defineProperty(r.prototype,y,{enumerable:!1,value:f(y)})}}catch(e){h=!0,p=e}finally{try{l||null==d.return||d.return()}finally{if(h)throw p}}return r}}}]),i(t,[{key:"on",value:function(e,t){return b(e),g(t),k(this,e).add(t),this.off.bind(this,e,t)}},{key:"off",value:function(e,t){b(e),g(t),k(this,e).delete(t)}},{key:"once",value:function(e){var t=this;return new Promise(function(n){b(e);var r=t.on(e,function(e){r(),n(e)})})}},{key:"events",value:function(e){return b(e),E(this,e)}},{key:"emit",value:function(){var e=n(regeneratorRuntime.mark(function e(t,r){var o,i,s,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return b(t),_(this,t,r),o=k(this,t),i=p.get(this),s=f(o),a=f(i),e.next=8,m;case 8:return e.abrupt("return",Promise.all([].concat(f(s.map(function(){var e=n(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!o.has(t)){e.next=2;break}return e.abrupt("return",t(r));case 2:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}())),f(a.map(function(){var e=n(regeneratorRuntime.mark(function e(n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!i.has(n)){e.next=2;break}return e.abrupt("return",n(t,r));case 2:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}())))));case 9:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"emitSerial",value:function(){var e=n(regeneratorRuntime.mark(function e(t,n){var r,o,i,s,a,c,u,l,h,v,d,y,g,w,_,E;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return b(t),r=k(this,t),o=p.get(this),i=f(r),s=f(o),e.next=7,m;case 7:a=!0,c=!1,u=void 0,e.prev=10,l=i[Symbol.iterator]();case 12:if(a=(h=l.next()).done){e.next=20;break}if(v=h.value,!r.has(v)){e.next=17;break}return e.next=17,v(n);case 17:a=!0,e.next=12;break;case 20:e.next=26;break;case 22:e.prev=22,e.t0=e.catch(10),c=!0,u=e.t0;case 26:e.prev=26,e.prev=27,a||null==l.return||l.return();case 29:if(e.prev=29,!c){e.next=32;break}throw u;case 32:return e.finish(29);case 33:return e.finish(26);case 34:d=!0,y=!1,g=void 0,e.prev=37,w=s[Symbol.iterator]();case 39:if(d=(_=w.next()).done){e.next=47;break}if(E=_.value,!o.has(E)){e.next=44;break}return e.next=44,E(t,n);case 44:d=!0,e.next=39;break;case 47:e.next=53;break;case 49:e.prev=49,e.t1=e.catch(37),y=!0,g=e.t1;case 53:e.prev=53,e.prev=54,d||null==w.return||w.return();case 56:if(e.prev=56,!y){e.next=59;break}throw g;case 59:return e.finish(56);case 60:return e.finish(53);case 61:case"end":return e.stop()}},e,this,[[10,22,26,34],[27,,29,33],[37,49,53,61],[54,,56,60]])}));return function(t,n){return e.apply(this,arguments)}}()},{key:"onAny",value:function(e){return g(e),p.get(this).add(e),this.offAny.bind(this,e)}},{key:"anyEvent",value:function(){return E(this)}},{key:"offAny",value:function(e){g(e),p.get(this).delete(e)}},{key:"clearListeners",value:function(e){if("string"==typeof e){k(this,e).clear();var t=w(this,e),n=!0,r=!1,o=void 0;try{for(var i,s=t[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){i.value.finish()}}catch(e){r=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(r)throw o}}t.clear()}else{p.get(this).clear();var a=!0,c=!1,u=void 0;try{for(var f,l=v.get(this).values()[Symbol.iterator]();!(a=(f=l.next()).done);a=!0){f.value.clear()}}catch(e){c=!0,u=e}finally{try{a||null==l.return||l.return()}finally{if(c)throw u}}var h=!0,y=!1,m=void 0;try{for(var b,g=d.get(this).values()[Symbol.iterator]();!(h=(b=g.next()).done);h=!0){var _=b.value,E=!0,x=!1,S=void 0;try{for(var P,A=_[Symbol.iterator]();!(E=(P=A.next()).done);E=!0){P.value.finish()}}catch(e){x=!0,S=e}finally{try{E||null==A.return||A.return()}finally{if(x)throw S}}_.clear()}}catch(e){y=!0,m=e}finally{try{h||null==g.return||g.return()}finally{if(y)throw m}}}}},{key:"listenerCount",value:function(e){if("string"==typeof e)return p.get(this).size+k(this,e).size+w(this,e).size+w(this).size;void 0!==e&&b(e);var t=p.get(this).size,n=!0,r=!1,o=void 0;try{for(var i,s=v.get(this).values()[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){t+=i.value.size}}catch(e){r=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(r)throw o}}var a=!0,c=!1,u=void 0;try{for(var f,l=d.get(this).values()[Symbol.iterator]();!(a=(f=l.next()).done);a=!0){t+=f.value.size}}catch(e){c=!0,u=e}finally{try{a||null==l.return||l.return()}finally{if(c)throw u}}return t}},{key:"bindMethods",value:function(t,n){if("object"!==e(t)||null===t)throw new TypeError("`target` must be an object");n=x(n);var r=!0,o=!1,i=void 0;try{for(var s,a=n[Symbol.iterator]();!(r=(s=a.next()).done);r=!0){var c=s.value;if(void 0!==t[c])throw new Error("The property `".concat(c,"` already exists on `target`"));Object.defineProperty(t,c,{enumerable:!1,value:this[c].bind(this)})}}catch(e){o=!0,i=e}finally{try{r||null==a.return||a.return()}finally{if(o)throw i}}}}]),t}(),P=Object.getOwnPropertyNames(S.prototype).filter(function(e){return"constructor"!==e});S.Typed=function(e){function t(){return r(this,t),u(this,a(t).apply(this,arguments))}return s(t,S),t}(),Object.defineProperty(S.Typed,"Typed",{enumerable:!1,value:void 0});var A=S,O=function(e){return encodeURIComponent(e).replace(/[!'()*]/g,function(e){return"%".concat(e.charCodeAt(0).toString(16).toUpperCase())})};function j(e,t){return t.encode?t.strict?O(e):encodeURIComponent(e):e}var R=function(e,t){if(!e)return"";var n=function(e){switch(e.arrayFormat){case"index":return function(t){return function(n,r){var o=n.length;return void 0===r?n:[].concat(f(n),null===r?[[j(t,e),"[",o,"]"].join("")]:[[j(t,e),"[",j(o,e),"]=",j(r,e)].join("")])}};case"bracket":return function(t){return function(n,r){return void 0===r?n:[].concat(f(n),null===r?[[j(t,e),"[]"].join("")]:[[j(t,e),"[]=",j(r,e)].join("")])}};case"comma":return function(t){return function(n,r,o){return null==r||0===r.length?n:0===o?[[j(t,e),"=",j(r,e)].join("")]:[[n,j(r,e)].join(",")]}};default:return function(t){return function(n,r){return void 0===r?n:[].concat(f(n),null===r?[j(t,e)]:[[j(t,e),"=",j(r,e)].join("")])}}}}(t=Object.assign({encode:!0,strict:!0,arrayFormat:"none"},t)),r=Object.keys(e);return!1!==t.sort&&r.sort(t.sort),r.map(function(r){var o=e[r];return void 0===o?"":null===o?j(r,t):Array.isArray(o)?o.reduce(n(r),[]).join("&"):j(r,t)+"="+j(o,t)}).filter(function(e){return e.length>0}).join("&")},T=1e3,C=60*T,L=60*C,N=24*L,I=365.25*N,J=function(t,n){n=n||{};var r=e(t);if("string"===r&&t.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(e);if(!t)return;var n=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return n*I;case"days":case"day":case"d":return n*N;case"hours":case"hour":case"hrs":case"hr":case"h":return n*L;case"minutes":case"minute":case"mins":case"min":case"m":return n*C;case"seconds":case"second":case"secs":case"sec":case"s":return n*T;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return}}(t);if("number"===r&&!1===isNaN(t))return n.long?function(e){return M(e,N,"day")||M(e,L,"hour")||M(e,C,"minute")||M(e,T,"second")||e+" ms"}(t):function(e){if(e>=N)return Math.round(e/N)+"d";if(e>=L)return Math.round(e/L)+"h";if(e>=C)return Math.round(e/C)+"m";if(e>=T)return Math.round(e/T)+"s";return e+"ms"}(t);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(t))};function M(e,t,n){if(!(e<t))return e<1.5*t?Math.floor(e/t)+" "+n:Math.ceil(e/t)+" "+n+"s"}var Q=l(function(e,t){var n;function r(e){function r(){if(r.enabled){var e=r,o=+new Date,i=o-(n||o);e.diff=i,e.prev=n,e.curr=o,n=o;for(var s=new Array(arguments.length),a=0;a<s.length;a++)s[a]=arguments[a];s[0]=t.coerce(s[0]),"string"!=typeof s[0]&&s.unshift("%O");var c=0;s[0]=s[0].replace(/%([a-zA-Z%])/g,function(n,r){if("%%"===n)return n;c++;var o=t.formatters[r];if("function"==typeof o){var i=s[c];n=o.call(e,i),s.splice(c,1),c--}return n}),t.formatArgs.call(e,s),(r.log||t.log||console.log.bind(console)).apply(e,s)}}return r.namespace=e,r.enabled=t.enabled(e),r.useColors=t.useColors(),r.color=function(e){var n,r=0;for(n in e)r=(r<<5)-r+e.charCodeAt(n),r|=0;return t.colors[Math.abs(r)%t.colors.length]}(e),"function"==typeof t.init&&t.init(r),r}(t=e.exports=r.debug=r.default=r).coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){t.enable("")},t.enable=function(e){t.save(e),t.names=[],t.skips=[];for(var n=("string"==typeof e?e:"").split(/[\s,]+/),r=n.length,o=0;o<r;o++)n[o]&&("-"===(e=n[o].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){var n,r;for(n=0,r=t.skips.length;n<r;n++)if(t.skips[n].test(e))return!1;for(n=0,r=t.names.length;n<r;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=J,t.names=[],t.skips=[],t.formatters={}}),z=(Q.coerce,Q.disable,Q.enable,Q.enabled,Q.humanize,Q.names,Q.skips,Q.formatters,l(function(t,n){function r(){var e;try{e=n.storage.debug}catch(e){}return!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG),e}(n=t.exports=Q).log=function(){return"object"===("undefined"==typeof console?"undefined":e(console))&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},n.formatArgs=function(e){var t=this.useColors;if(e[0]=(t?"%c":"")+this.namespace+(t?" %c":" ")+e[0]+(t?"%c ":" ")+"+"+n.humanize(this.diff),!t)return;var r="color: "+this.color;e.splice(1,0,r,"color: inherit");var o=0,i=0;e[0].replace(/%[a-zA-Z%]/g,function(e){"%%"!==e&&(o++,"%c"===e&&(i=o))}),e.splice(i,0,r)},n.save=function(e){try{null==e?n.storage.removeItem("debug"):n.storage.debug=e}catch(e){}},n.load=r,n.useColors=function(){if("undefined"!=typeof window&&window.process&&"renderer"===window.process.type)return!0;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},n.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(e){}}(),n.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"],n.formatters.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}},n.enable(r())})),V=(z.log,z.formatArgs,z.save,z.load,z.useColors,z.storage,z.colors,l(function(e){var t=z;t.enable("adonis:*"),e.exports=t("adonis:websocket")})),B={name:"json",encode:function(e,t){var n=null;try{n=JSON.stringify(e)}catch(e){return t(e)}t(null,n)},decode:function(e,t){var n=null;try{n=JSON.parse(e)}catch(e){return t(e)}t(null,n)}},U=function(){function e(t,n){r(this,e),this.topic=t,this.connection=n,this.emitter=new A,this._state="pending",this._emitBuffer=[]}return i(e,[{key:"joinAck",value:function(){var e=this;this.state="open",this.emitter.emit("ready",this),V("clearing emit buffer for %s topic after subscription ack",this.topic),this._emitBuffer.forEach(function(t){return e.emit(t.event,t.data)}),this._emitBuffer=[]}},{key:"joinError",value:function(e){this.state="error",this.emitter.emit("error",e),this.serverClose()}},{key:"leaveAck",value:function(){this.state="closed",this.serverClose()}},{key:"leaveError",value:function(e){this.emitter.emit("leaveError",e)}},{key:"on",value:function(){var e;return(e=this.emitter).on.apply(e,arguments)}},{key:"once",value:function(){var e;(e=this.emitter).once.apply(e,arguments)}},{key:"off",value:function(){var e;(e=this.emitter).off.apply(e,arguments)}},{key:"emit",value:function(e,t){"pending"!==this.state?this.connection.sendEvent(this.topic,e,t):this._emitBuffer.push({event:e,data:t})}},{key:"serverClose",value:function(){var e=this;return this.emitter.emit("close",this).then(function(){e._emitBuffer=[],e.emitter.clearListeners()}).catch(function(){e._emitBuffer=[],e.emitter.clearListeners()})}},{key:"serverEvent",value:function(e){var t=e.event,n=e.data;this.emitter.emit(t,n)}},{key:"serverError",value:function(){this.state="error"}},{key:"close",value:function(){this.state="closing",V("closing subscription for %s topic with server",this.topic),this.connection.sendPacket(h.leavePacket(this.topic))}},{key:"terminate",value:function(){this.leaveAck()}},{key:"state",get:function(){return this._state},set:function(e){if(-1===!this.constructor.states.indexOf(e))throw new Error("".concat(e," is not a valid socket state"));this._state=e}}],[{key:"states",get:function(){return["pending","open","closed","closing","error"]}}]),e}(),W="wss",q=function(e){function t(e,n){var o;return r(this,t),o=u(this,a(t).call(this)),e=e||"".concat(W,"://").concat(window.location.host),o.options=Object.assign({path:"adonis-ws",reconnection:!0,reconnectionAttempts:10,reconnectionDelay:1e3,query:null,encoder:B},n),V("connection options %o",o.options),o._connectionState="idle",o._reconnectionAttempts=0,o._packetsQueue=[],o._processingQueue=!1,o._pingTimer=null,o._extendedQuery={},o._url="".concat(e.replace(/\/$/,""),"/").concat(o.options.path),o.subscriptions={},o.removeSubscription=function(e){var t=e.topic;delete o.subscriptions[t]},o}return s(t,A),i(t,[{key:"_cleanup",value:function(){clearInterval(this._pingTimer),this.ws=null,this._pingTimer=null}},{key:"_subscriptionsIterator",value:function(e){var t=this;Object.keys(this.subscriptions).forEach(function(n){return e(t.subscriptions[n],n)})}},{key:"_ensureSubscription",value:function(e,t){var n=this.getSubscription(e.d.topic);n?t(n,e):V("cannot consume packet since %s topic has no active subscription %j",e.d.topic,e)}},{key:"_processQueue",value:function(){var e=this;!this._processingQueue&&this._packetsQueue.length&&(this._processingQueue=!0,this.options.encoder.encode(this._packetsQueue.shift(),function(t,n){t?V("encode error %j",t):(e.write(n),e._processingQueue=!1,e._processQueue())}))}},{key:"_onOpen",value:function(){V("opened")}},{key:"_onError",value:function(e){V("error %O",e),this._subscriptionsIterator(function(e){return e.serverError()}),this.emit("error",e)}},{key:"_reconnect",value:function(){var e=this;this._reconnectionAttempts++,this.emit("reconnect",this._reconnectionAttempts),setTimeout(function(){e._connectionState="reconnect",e.connect()},this.options.reconnectionDelay*this._reconnectionAttempts)}},{key:"_onClose",value:function(e){var t=this;V("closing from %s state",this._connectionState),this._cleanup(),this._subscriptionsIterator(function(e){return e.terminate()}),this.emit("close",this).then(function(){t.shouldReconnect?t._reconnect():t.clearListeners()}).catch(function(){t.shouldReconnect?t._reconnect():t.clearListeners()})}},{key:"_onMessage",value:function(e){var t=this;this.options.encoder.decode(e.data,function(e,n){e?V("packet dropped, decode error %o",e):t._handleMessage(n)})}},{key:"_handleMessage",value:function(e){return h.isOpenPacket(e)?(V("open packet"),void this._handleOpen(e)):h.isJoinAckPacket(e)?(V("join ack packet"),void this._handleJoinAck(e)):h.isJoinErrorPacket(e)?(V("join error packet"),void this._handleJoinError(e)):h.isLeaveAckPacket(e)?(V("leave ack packet"),void this._handleLeaveAck(e)):h.isLeaveErrorPacket(e)?(V("leave error packet"),void this._handleLeaveError(e)):h.isLeavePacket(e)?(V("leave packet"),void this._handleServerLeave(e)):h.isEventPacket(e)?(V("event packet"),void this._handleEvent(e)):void(h.isPongPacket(e)?V("pong packet"):V("invalid packet type %d",e.t))}},{key:"_handleOpen",value:function(e){var t=this;this._connectionState="open",this.emit("open",e.d),this._pingTimer=setInterval(function(){t.sendPacket(h.pingPacket())},e.d.clientInterval),V("processing pre connection subscriptions %o",Object.keys(this.subscriptions)),this._subscriptionsIterator(function(e){t._sendSubscriptionPacket(e.topic)})}},{key:"_handleJoinAck",value:function(e){this._ensureSubscription(e,function(e){return e.joinAck()})}},{key:"_handleJoinError",value:function(e){this._ensureSubscription(e,function(e,t){return e.joinError(t.d)})}},{key:"_handleLeaveAck",value:function(e){this._ensureSubscription(e,function(e){return e.leaveAck()})}},{key:"_handleLeaveError",value:function(e){this._ensureSubscription(e,function(e,t){return e.leaveError(t.d)})}},{key:"_handleServerLeave",value:function(e){this._ensureSubscription(e,function(e,t){return e.leaveAck()})}},{key:"_handleEvent",value:function(e){this._ensureSubscription(e,function(e,t){return e.serverEvent(t.d)})}},{key:"_sendSubscriptionPacket",value:function(e){V("initiating subscription for %s topic with server",e),this.sendPacket(h.joinPacket(e))}},{key:"connect",value:function(){var e=this,t=R(Object.assign({},this.options.query,this._extendedQuery)),n=t?"".concat(this._url,"?").concat(t):this._url;return V("creating socket connection on %s url",n),this.ws=new window.WebSocket(n),this.ws.onclose=function(t){return e._onClose(t)},this.ws.onerror=function(t){return e._onError(t)},this.ws.onopen=function(t){return e._onOpen(t)},this.ws.onmessage=function(t){return e._onMessage(t)},this}},{key:"write",value:function(e){this.ws.readyState===window.WebSocket.OPEN?this.ws.send(e):V("connection is not in open state, current state %s",this.ws.readyState)}},{key:"sendPacket",value:function(e){this._packetsQueue.push(e),this._processQueue()}},{key:"getSubscription",value:function(e){return this.subscriptions[e]}},{key:"hasSubcription",value:function(e){return!!this.getSubscription(e)}},{key:"subscribe",value:function(e){if(!e||"string"!=typeof e)throw new Error("subscribe method expects topic to be a valid string");if(this.subscriptions[e])throw new Error("Cannot subscribe to same topic twice. Instead use getSubscription");var t=new U(e,this);return t.on("close",this.removeSubscription),this.subscriptions[e]=t,"open"===this._connectionState&&this._sendSubscriptionPacket(e),t}},{key:"sendEvent",value:function(e,t,n){if(!e||!t)throw new Error("topic and event name is required to call sendEvent method");var r=this.getSubscription(e);if(!r)throw new Error("There is no active subscription for ".concat(e," topic"));if("open"!==r.state)throw new Error("Cannot emit since subscription socket is in ".concat(this.state," state"));V("sending event on %s topic",e),this.sendPacket(h.eventPacket(e,t,n))}},{key:"withJwtToken",value:function(e){return this._extendedQuery.token=e,this}},{key:"withBasicAuth",value:function(e,t){return this._extendedQuery.basic=window.btoa("".concat(e,":").concat(t)),this}},{key:"withApiToken",value:function(e){return this._extendedQuery.token=e,this}},{key:"close",value:function(){this._connectionState="terminated",this.ws.close()}},{key:"shouldReconnect",get:function(){return"terminated"!==this._connectionState&&this.options.reconnection&&this.options.reconnectionAttempts>this._reconnectionAttempts}}]),t}();return function(e,t){return new q(e,t)}});